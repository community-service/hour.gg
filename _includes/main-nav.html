<nav id="site-navbar" class="navbar navbar-dark bg-black fixed-top navbar-expand-custom">
  <div class="container-fluid csh-navbar-wrap px-2">
    <!-- Top bar row (ONLY height we reserve with the spacer) -->
    <div class="csh-bar-row">
      <a class="navbar-brand d-flex align-items-center csh-brand" href="/">
        <img src="/assets/logo.webp" alt="Community Service Hour" height="40">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>

    <!-- Collapsible content (overlays page; does NOT change spacer height) -->
    <div class="collapse navbar-collapse csh-collapse" id="navbarSupportedContent">
      <div class="csh-collapse-inner">
        <ul class="navbar-nav csh-links">
          <!-- New links first -->
          <li class="nav-item">
            <a class="nav-link" href="/episodes">EPISODES</a>
          </li>
          <li class="nav-item csh-pair-sep">
            <a class="nav-link" href="/participants">PARTICIPANTS</a>
          </li>

          <!-- Existing links -->
          <li class="nav-item">
            <a class="nav-link"
              href="https://twitter.com/intent/tweet?text=Hello%20@fulldecent%20I%20have%20a%20question%20for%20%23CommunityServiceHour">ASK
              A QUESTION</a>
          </li>
          <li class="nav-item">
            <a class="nav-link"
              href="https://twitter.com/messages/compose?recipient_id=47729549&text=Hello%20I'd%20like%20to%20be%20interviewed%20on%20Community%20Service%20Hour.%20Here's%20some%20details%20about%20my%20project&hellip;">GET
              INTERVIEWED</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              PODCAST
            </a>
            <ul class="dropdown-menu csh-dropdown">
              <li><a class="dropdown-item"
                  href="https://podcasts.apple.com/us/podcast/community-service-hour/id1662422217"><i
                    class="bi bi-apple"></i> Apple podcasts</a></li>
              <li><a class="dropdown-item" href="https://open.spotify.com/show/3k4PnmjfLiuNo9HpXemCdJ"><i
                    class="bi bi-spotify"></i> Spotify podcasts</a></li>
              <li><a class="dropdown-item"
                  href="https://www.youtube.com/playlist?list=PLaMigeN8Exx-ChNPpO-j6pFQ3F8oJWrBN"><i
                    class="bi bi-youtube"></i> YouTube channel</a></li>
              <li><a class="dropdown-item" href="https://www.twitch.tv/fulldecent"><i class="bi bi-twitch"></i> Twitch
                  channel</a></li>
            </ul>
          </li>
        </ul>

        <div class="csh-actions">
          <div class="d-flex align-items-center gap-2 csh-social">
            <a href="https://twitter.com/fulldecent" class="btn btn-outline-light" aria-label="Join live on X">
              <i class="bi bi-twitter-x"></i>
            </a>
            <a href="https://www.twitch.tv/fulldecent" class="btn btn-outline-light" aria-label="Join live on Twitch">
              <i class="bi bi-twitch"></i>
            </a>
          </div>

          <a href="https://github.com/users/fulldecent/projects/" class="btn btn-primary csh-invest-btn">INVEST TIME</a>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Spacer to simulate ONLY the top-bar height (so expanding menu overlays the page and doesn't push it down) -->
<div id="navbar-spacer" aria-hidden="true"></div>

<style>
  #navbar-spacer {
    height: 0;
  }

  .navbar-nav .nav-link {
    color: rgba(255, 255, 255, 0.85);
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .navbar-nav .nav-link:hover {
    color: #f22f54 !important;
  }

  /* Dropdown styling (dark + subtle brighter hover, not white) */
  .csh-dropdown {
    background: rgba(0, 0, 0, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.14);
  }

  .csh-dropdown .dropdown-item {
    color: rgba(255, 255, 255, 0.85);
  }

  .csh-dropdown .dropdown-item:hover,
  .csh-dropdown .dropdown-item:focus {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
  }

  /* Mobile/tablet base (<=1299px): bar row compact; collapse overlays content below */
  .csh-bar-row {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .csh-brand {
    margin-right: 0.75rem;
  }

  .csh-collapse {
    width: 100%;
    background: #000;
  }

  /* Put padding on an inner wrapper so Bootstrap's height animation can fully clip it. */
  .csh-collapse-inner {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .csh-links {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin-bottom: 0.75rem;
  }

  .csh-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }

  /* Mobile: inset the OPENED menu content from the edges */
  @media (max-width: 949.98px) {
    .csh-collapse-inner {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .csh-invest-btn {
      margin-top: 0.25rem;
    }

    .csh-pair-sep {
      margin-right: 0;
    }

    /* Mobile dropdown should behave like inline content (fine if it expands layout inside collapse) */
    #site-navbar .dropdown-menu {
      position: static;
      float: none;
    }

    /* Smooth expand/collapse animation for mobile dropdown */
    #site-navbar .csh-dropdown {
      display: block !important;
      max-height: 0;
      overflow: hidden;
      padding: 0;
      margin: 0;
      border: none;
      transition: max-height 0.25s ease-out, padding 0.25s ease-out;
    }

    #site-navbar .csh-dropdown.show {
      max-height: 200px;
      padding: 0.5rem 0;
    }
  }

  /* Desktop (>=950px): centered structure; dropdown should OVERLAY, not expand the navbar height */
  @media (min-width: 950px) {
    .navbar-expand-custom .navbar-toggler {
      display: none;
    }

    #site-navbar .csh-navbar-wrap {
      display: flex;
      align-items: center;
      justify-content: center !important;
      gap: 0.75rem;
      width: 100%;
    }

    #site-navbar .csh-bar-row,
    #site-navbar .csh-collapse {
      flex: 0 0 auto;
    }

    #site-navbar .csh-collapse {
      flex-grow: 0 !important;
      display: flex !important;
      flex-basis: auto;
      align-items: center;
      width: auto;
      background: transparent;
      padding: 0;
    }

    #site-navbar .csh-collapse-inner {
      display: flex;
      align-items: center;
      padding: 0;
    }

    #site-navbar .csh-bar-row {
      width: auto;
      justify-content: flex-start;
    }

    #site-navbar .csh-links {
      flex-direction: row;
      align-items: center;
      gap: 1rem;
      margin: 0;
    }

    #site-navbar .csh-pair-sep {
      margin-right: 2.25rem;
    }

    #site-navbar .csh-actions {
      flex-direction: row;
      align-items: center;
      gap: 0;
      margin-left: 2rem;
    }

    #site-navbar .csh-social {
      margin-right: 0.5rem;
    }

    #site-navbar .csh-invest-btn {
      margin-top: 0;
    }

    /* KEY FIX: Bootstrap doesn't know our custom expand class, so it keeps dropdown "static".
       Force desktop dropdown to be absolute + overlay so it doesn't change navbar height. */
    #site-navbar .nav-item.dropdown {
      position: relative;
    }

    #site-navbar .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1050;
      margin-top: 0.35rem;
    }
  }
</style>

<script>
  (function () {
    function syncNavbarSpacer() {
      var navbar = document.getElementById('site-navbar');
      var spacer = document.getElementById('navbar-spacer');
      var barRow = navbar ? navbar.querySelector('.csh-bar-row') : null;
      if (!barRow || !spacer) return;

      // Reserve ONLY the bar row height (not expanded menu)
      spacer.style.height = barRow.offsetHeight + 'px';
    }

    function setupClickOutsideToClose() {
      var nav = document.getElementById('site-navbar');
      var collapseEl = document.getElementById('navbarSupportedContent');
      if (!nav || !collapseEl) return;

      function isMobileMode() {
        return window.matchMedia('(max-width: 949.98px)').matches;
      }

      function closeIfOpen() {
        if (!collapseEl.classList.contains('show')) return;

        if (window.bootstrap && window.bootstrap.Collapse) {
          var inst = window.bootstrap.Collapse.getInstance(collapseEl);
          if (!inst) inst = new window.bootstrap.Collapse(collapseEl, { toggle: false });
          inst.hide();
        } else {
          collapseEl.classList.remove('show');
        }
      }

      function onDocPointer(e) {
        if (!isMobileMode()) return;
        if (!collapseEl.classList.contains('show')) return;
        if (nav.contains(e.target)) return;
        closeIfOpen();
      }

      document.addEventListener('click', onDocPointer, true);
      document.addEventListener('touchstart', onDocPointer, true);

      window.addEventListener('resize', function () {
        if (!isMobileMode()) closeIfOpen();
      });
    }

    function setupDropdownAutoClose() {
      var collapseEl = document.getElementById('navbarSupportedContent');
      if (!collapseEl) return;

      // When main menu starts closing, immediately close the dropdown too
      collapseEl.addEventListener('hide.bs.collapse', function () {
        var dropdown = collapseEl.querySelector('.csh-dropdown');
        if (dropdown) dropdown.classList.remove('show');
        var toggle = collapseEl.querySelector('.dropdown-toggle');
        if (toggle) toggle.setAttribute('aria-expanded', 'false');
      });
    }

    syncNavbarSpacer();
    requestAnimationFrame(syncNavbarSpacer);
    window.addEventListener('load', function () {
      syncNavbarSpacer();
      setupClickOutsideToClose();
      setupDropdownAutoClose();
    });
    window.addEventListener('resize', syncNavbarSpacer);
  })();
</script>
